!function(){"use strict";var s,u,t,d={},f=function(){return document.querySelector.apply(document,arguments)};function l(e){return null!=e}function p(e,t,n){return function e(t,n){return n<=0?"":t+e(t,n-1)}(n=(n||" ").substr(0,1),t-e.length)+e}function h(e,t){var n=document.createElement(e);return l(t)&&Object.keys(t).forEach(function(e){n[e]=t[e]}),n}function v(e){for(;e.firstChild;)e.removeChild(e.firstChild);return e}function o(e,t){e.classList?e.classList.add(t):e.className+=" "+t}function n(e,t,n){e.addEventListener?e.addEventListener(t,n):e.attachEvent("on"+t,function(){n.call(e)})}function a(e){var t=new RegExp("(?:(?:^|.*;\\s*)"+e+"\\s*\\=\\s*([^;]*).*$)|^.*$");return decodeURIComponent(document.cookie.replace(t,"$1"))}function m(){var e=new Date;return 60*e.getHours()*60+60*e.getMinutes()+e.getSeconds()}function _(e){var t=Math.floor(e/60);return[Math.floor(t/60)%24,t%60].map(function(e){return p(e.toString(),2,"0")}).join(":")}function g(e,t){return Math.round((t-e)/60)}function y(){return"now"===(l(f(".when-button.selected"))?encodeURIComponent(f(".when-button.selected").getAttribute("value")):"")}var w={weekday:1,saturday:6,sunday:0};function i(n,t){var r=l(f(".when-button.selected"))?encodeURIComponent(f(".when-button.selected").getAttribute("value")):"",e=new Date,o=(new Date).getDay();if("now"===r)switch(o){case 1:case 2:case 3:case 4:case 5:r="weekday";break;case 6:r="saturday";break;case 0:r="sunday";break;default:return console.error("Unknown current day",o),[]}else{var a=(w[r]+7-o)%7;e.setDate(e.getDate()+a)}var i=function(e){return parseInt([e.getFullYear(),e.getMonth()+1,e.getDate()].map(function(e){return p(e.toString(),2,"0")}).join(""))}(e),c=Object.keys(n).filter(function(e){var t=n[e];return t.start_date<=i&&i<=t.end_date}).filter(function(e){return n[e][r]});return 0===(c=c.filter(function(e){return!(e in t)||0===t[e].filter(function(e){return e[0]===i&&2===e[1]}).length}).concat(Object.keys(t).filter(function(e){return 0!==t[e].filter(function(e){return e[0]===i&&1===e[1]}).length}))).length&&console.log("Can't get service for now."),c}function T(r,e,t){var o={};return i(e,t).forEach(function(n){Object.keys(r).forEach(function(e){var t=r[e][n];l(t)&&(l(o[e])||(o[e]={}),function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}(o[e],t))})}),o}function k(t,e){return e.map(function(e){return t.indexOf(e)}).filter(function(e){return-1!=e})}function x(e,t){return e.departure_time-t.departure_time}function r(){var e=d.stops,t=d.routes,n=d.calendar,r=d.calendar_dates,o=e[s.getText()],a=e[u.getText()],i=T(t,n,r);if(l(o)&&l(a)&&l(i)){var c=function(t,s,u){var d=[];return Object.keys(t).forEach(function(e){var c=t[e];Object.keys(c).forEach(function(e){var t=c[e],n=t.map(function(e){return e[0]}),r=k(n,s),o=k(n,u);if(l(r)&&l(o)&&0!==r.length&&0!==o.length){var a=Math.min.apply(this,r),i=Math.max.apply(this,o);i<=a||(!y()||t[a][1]>m())&&d.push({departure_time:t[a][1],arrival_time:t[i][1]})}})}),d.sort(x)}(i,o,a);!function(){var e=";expires="+new Date(Date.now()+31536e6).toUTCString();document.cookie="from="+encodeURIComponent(s.getText())+e,document.cookie="to="+encodeURIComponent(u.getText())+e;var t=l(f(".when-button.selected"))?encodeURIComponent(f(".when-button.selected").getAttribute("value")):"";document.cookie="when="+t+e}(),function(e){var t=v(f("#info"));if(y()&&l(e)){var n=h("div",{className:"info",textContent:"Next train: "+g(m(),e.departure_time)+"min"});t.appendChild(n)}}(c[0]),function(e){var a=v(f("#result"));e.forEach(function(e){var t=h("span",{className:"departure",textContent:_(e.departure_time)}),n=h("span",{className:"duration",textContent:g(e.departure_time,e.arrival_time)+" min"}),r=h("span",{className:"arrival",textContent:_(e.arrival_time)}),o=h("div",{className:"trip"});o.appendChild(t),o.appendChild(n),o.appendChild(r),a.appendChild(o)})}(c)}}function c(){[s,u].forEach(function(e){e.on("focus",function(){e.setText(""),e.input.Show()}),e.on("change",r),e.on("complete",r)}),t.forEach(function(e){n(e,"click",function(){t.forEach(function(e){!function(e,t){e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")}(e,"selected")}),o(e,"selected"),r()})}),n(f("#reverse"),"click",function(){var e=s.getText();s.setText(u.getText()),u.setText(e),r()})}function C(){FastClick.attach(document.body),s=rComplete(f("#from"),{placeholder:"Departure"}),u=rComplete(f("#to"),{placeholder:"Destination"}),t=function(){var t=document.querySelectorAll.apply(document,arguments);return t.forEach=function(e){[].forEach.call(t,e)},t}(".when-button");var e=Object.keys(d.stops);s.setOptions(e),u.setOptions(e),function(){var e=a("from"),t=a("to"),n=a("when");if(l(e)&&s.setText(e),l(t)&&u.setText(t),l(n)){var r=f('.when-button[value="'+n+'"]');l(r)&&o(r,"selected")}}(),c(),r(),"?test=true"===window.location.search&&function(k,x,o,C){console.debug("Fetching test data"),b({weekday_NB_TT:"test/weekday_NB_TT.json",weekday_SB_TT:"test/weekday_SB_TT.json",weekend_NB_TT:"test/weekend_NB_TT.json",weekend_SB_TT:"test/weekend_SB_TT.json"},function(e){console.debug("Start testing");var r=h("div",{id:"test_result"});function g(e,t){if(!e){var n=h("div",{className:"test_result_item"});t.split("\n").forEach(function(e){n.appendChild(h("div",{textContent:e}))}),r.appendChild(n)}return e}function y(e){var t=e.split(":");return t[0]=t[0]%24,t.map(function(e){return p(e.toString(),2,"0")}).join(":")}function w(e){return"["+y(e[0])+"=>"+y(e[1])+"]"}function T(e){return"["+e[0]+"=>"+e[1]+"]"}function t(e,t){for(var n=e.length-1;0<=n;n--){var r=e[n].name,o=e[n].stop_times;if(g(0<=x.getOptions().indexOf(r),"to_name is not in options:"+r)){x.setText(r);for(var a=n-1;0<=a;a--){var i=e[a].name,c=e[a].stop_times;if(g(0<=k.getOptions().indexOf(i),"from_name is not in options:"+i)){k.setText(i);var s=[];if(g(c.length===o.length,"from_stops and to_stops have different length:"+i+"=>"+r))for(var u=c.length-1;0<=u;u--){var d=c[u],f=o[u];if(g(d.service_type===f.service_type,"from_stop and to_stop have different type: schedule:"+t+", "+i+"("+d.service_type+")=>"+r+"("+f.service_type+")["+d.time+"=>"+f.time+"]")){if("SatOnly"===d.service_type&&"saturday"!==t)continue;d.time&&f.time&&s.unshift([d.time,f.time])}}s.sort(function(e,t){return(e=e[0]+"=>"+e[1])<(t=t[0]+"=>"+t[1])?-1:t<e?1:0});for(var l=[],p=C.children.length-1;0<=p;p--){var h=C.children[p];l.unshift([h.children[0].textContent,h.children[2].textContent])}if(g(s.length===l.length,"expects and actuals have different length:"+i+"=>"+r+"\nexpects:"+s.map(w).join(", ")+"\nactuals:"+l.map(T).join(", ")))for(var v=l.length-1;0<=v;v--){var m=y(s[v][0]),_=y(s[v][1]);g(l[v][0]===m&&l[v][1]===_,"time mismatch: schedule:"+t+", "+i+"=>"+r+", expected:("+m+" => "+_+"), actual:("+l[v][0]+" => "+l[v][1]+")")}}}}}}document.documentElement.appendChild(r),o[1].click(),t(e.weekday_NB_TT,"weekday"),t(e.weekday_SB_TT,"weekday"),o[2].click(),t(e.weekend_NB_TT,"saturday"),t(e.weekend_SB_TT,"saturday"),o[3].click(),t(e.weekend_NB_TT,"sunday"),t(e.weekend_SB_TT,"sunday");var n=h("div",{textContent:"Total failed:"+r.children.length});r.insertBefore(n,r.firstChild),console.debug("Finish testing")})}(s,u,t,f("#result"))}function b(e,r){var o={};Object.keys(e).forEach(function(e){o[e]=void 0}),Object.keys(e).forEach(function(n){!function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.onreadystatechange=function(){if(4===this.readyState)if(200<=this.status&&this.status<400){var e=JSON.parse(this.responseText);t(e)}else console.error("Fetch failed!")},n.send(),n=null}(e[n],function(e){for(var t in o[n]=e,o)if(void 0===o[t])return;r(o)})})}b({calendar:"data/calendar.json",calendar_dates:"data/calendar_dates.json",stops:"data/stops.json",routes:"data/routes.json"},function(e){d=e,function(e){"loading"!=document.readyState?e():document.addEventListener?document.addEventListener("DOMContentLoaded",e):document.attachEvent("onreadystatechange",function(){"loading"!=document.readyState&&e()})}(C)})}();